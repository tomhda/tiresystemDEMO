# タイヤ画像アップロード→最適タイヤ推薦 デモサイト 要件定義書 v1.0

---

## 0. ドキュメント情報
- 文書種別: 要件定義書（デモ用最小構成 / MVP）
- 対象読者: クライアント担当者、営業、PM、デザイナー、実装エンジニア、インフラ運用者
- 作成目的: 法人比率が高い現状から**個人向け販売拡大**に資する、"写真だけで最適タイヤが出る" 体験を**短期間で実演**するための要件確定
- 想定環境: スマートフォン（iOS/Android）・PCブラウザ（Chrome/Safari/Edge）
- 成果物範囲: **デモンストレーション用のテストサイト**（商用本番とは分離）

---

## 1. 背景と目的
- 背景: 現状の「かんたん診断」は、最終的にユーザーが**規格記号（例: 205/55R16 91V）**を理解して選択する必要があり、一般消費者には負担が大きい。
- 目的: **タイヤ側面の写真を1枚アップ**すれば、**最適なタイヤ候補と購入リンク**まで自動提示する体験を実現し、**“難しさの除去”**を実証する。
- デモの狙い: ①摩擦の少ないUI、②誤推薦を避ける安全ガード、③商品理解を助ける要約の3点を**短い時間で魅せる**。

---

## 2. スコープ / 非スコープ
### 2.1 スコープ（本デモで実装）
1) 画像アップロード（1枚）とサンプル画像選択
2) 画像前処理（傾き補正/コントラスト調整の軽処理）
3) OCR読取（サイズ・荷重指数:LI・速度記号:SS・季節マーク/ブランド名の抽出）
4) 決定論パーサ（正規表現＋辞書）で**規格値の正規化**
5) DB照合＆**安全ガード**（サイズ一致 + LI/SSが**同等以上**のみ表示）
6) 推薦結果一覧（最大3件）と**各商品の簡潔な説明（要約）**
7) 各商品の**販売ページへのリンク**（本番/ダミーの切替設定）
8) エラーハンドリング（読取不可時のリトライ/手入力補助）
9) 簡易イベント計測（アップロード、読取成功/失敗、クリック）
10) **サイズ手入力UI（タイヤ幅mm／扁平率％／R／リム径inch）**を常設（画像が不鮮明でも完了可能）

### 2.2 非スコープ（本デモでは扱わない）
- 本番決済、会員登録、在庫リアル連携、価格同期、自動配送見積
- 車種からの逆引き（車検証/ナンバー識別）
- 店舗予約・取り付けスケジュール連動
- 過去購入履歴の個別パーソナライズ

---

## 3. ユースケース
- UC-1: ユーザーがスマホでタイヤ側面を撮影→アップロード→**自動抽出**→**3件までの安全な候補**→商品ページへ遷移
- UC-2: 写真が不鮮明→**候補2～3通り**を提示し、**不足文字の手入力**で確定→商品ページへ遷移
- UC-3: 季節マーク（夏/オール/冬）が読めない→**季節フィルタをユーザー選択**→結果更新

---

## 4. 画面一覧と要件
### 4.1 画面一覧
1. **トップ/撮影ガイド**（/）
2. **画像アップロード**（/upload）
3. **読取結果確認**（/review）
4. **推薦結果一覧**（/recommendations）
5. **エラー/リトライ**（モーダル/トースト）
6. **サイズ手入力で探す**（/manual）

### 4.2 画面別詳細
**(1) トップ/撮影ガイド**
- CTA: 「写真をアップロード」ボタン
- 撮影ガイド: 「側面の規格表記が水平に写るように」「光を当てて影を避ける」など3点
- サンプル画像から開始: 2～3枚（成功/失敗例を含む）

**(2) 画像アップロード**
- 入力: JPEG/PNG/HEIC（最大10MB、横幅≥1280px）
- 端末対応: モバイルのカメラ起動可（accept="image/*;capture=camera"）
- 取り扱い: 画像は**デモ用の一時保存（60分で自動削除）**

**(3) 読取結果確認**
- 抽出フィールド（編集可能）: サイズ、LI、SS、季節、ブランド、パターン
- 信頼度表示（例: 85%）と不足文字ハイライト
- 不足時: 手入力補助（サイズ/LI/SSは選択肢付き）

**(4) 推薦結果一覧**
- 並び順: 在庫(デモ値) > 季節合致 > 静粛性 > 低燃費 > 価格昇順
- 各カード: 画像/商品名/主要規格/簡潔説明（80–120字）/価格(デモ)/「販売ページへ」
- 安全ガード: **LI/SSが現タイヤ未満の候補は非表示**

**(5) エラー/リトライ**
- 例: 「文字が読めませんでした」→再撮影ガイド提示＋再試行

**(6) サイズ手入力で探す**
- 入力項目: **タイヤ幅(mm)／扁平率(%)／R／リム径(インチ)**（例: 215 / 45 / R / 17）
- 自由入力: 「215/45 R17」「700R16」等も受け付け、正規化して検索
- 出力: 画像読取と同一ロジックで最大3件を提示

---

## 5. 機能要件
### 5.1 画像処理
- 前処理: 回転・傾き補正、コントラスト強調、ノイズ軽減
- 側面領域検出（任意/将来拡張）: YOLO等の軽量モデルによる自動トリミング（本デモでは固定クロップでも可）

### 5.2 OCR & パース
- OCRエンジン: 選択式（A: クラウドOCR［Google/Azure］、B: ローカル［PaddleOCRコンテナ］、C: ブラウザ内［Tesseract.js（英数字限定）］）
- 出力: 抽出テキスト＋座標＋信頼度
- パーサ（決定論）:
  - サイズ: `/\b\d{3}\/\d{2}R?\d{2}\b/`（例: 205/55R16）
  - LI（荷重指数）: 2–3桁（例: 91）
  - SS（速度記号）: 1–2文字（例: V/H/W/T など）
  - 季節: 3PMSF/ M+S / All Season / 夏
  - ブランド/パターン: ブランド辞書＋パターン名辞書（ファジー一致）

※ ライト版（ローカル実演）では **C: Tesseract.js** を既定とし、読取に失敗した場合は**サイズ手入力UI**で必ず完了できる。

### 5.3 推薦ロジック
- **必須一致**: サイズ（幅/扁平率/リム径）
- **安全条件**: LI・SSは**現タイヤ以上**のみ通過
- フィルタ: 季節（読取 or ユーザー選択）
- 並び替え: 在庫→静粛性→低燃費→価格→人気（同点は商品名昇順）
- 出力件数: 最大3件（カード表示）

### 5.4 LLMの補助利用（任意・オン/オフ可能）
- 不鮮明時の**候補補完**（例: 91V/92Hの2案提示と理由）
- 商品説明の**短文要約**（カタログ文を80–120字に整形）
- チャット式の絞り込み（静粛性重視/燃費重視など）

### 5.5 データベース
- データソース: **Googleスプレッドシート公開CSV**（提供URLを直接取得）
  - 取得URL（本デモ）: `https://docs.google.com/spreadsheets/d/e/2PACX-1vSE9zJ-UKPMwtt3eMYo4hCxZ_5hkZzCCrUpCZtERZDckafM7HcTu8d7Zfwch-0aBJois_rCOOMYHg0M/pub?output=csv`
  - 更新方式: フロント側でCSVをフェッチ→メモリ上に展開（5〜15分キャッシュ）
- 列マッピング（スプレッドシート → 内部項目）
  - `ブランド` → `brand`
  - `モデル名` → `pattern`
  - `タイヤサイズ` → `size_code`
  - `荷重指数(LI)` → `li`
  - `速度記号(SS)` → `ss`
  - `商品説明` → `summary`
  - `商品ページURL` → `product_url`
  - `特徴タグ` → `tags`（`winter|all|summer`等の季節推定に利用）
- 任意列（あれば使用）: `price_demo`, `stock_demo`
- 将来移行: 必要に応じてSQLite/PostgreSQLへ移行可能（スキーマは上記マッピングに準拠）

### 5.6 設定/切替
- OCRバックエンド: `cloud | local | browser`
- データソース: `google_sheet_csv_url`（環境変数や管理画面で差し替え）
- 商品リンク: `client_production | demo_mock`
- ログレベル: `info | debug`
- OCRバックエンド: `cloud | local | mock`
- 商品リンク: `client_production | demo_mock`
- ログレベル: `info | debug`

### 5.7 ログ/計測
- 取得イベント: `upload_start`, `ocr_ok/ng`, `parse_ok/ng`, `recommend_shown`, `product_click`
- 送信先: コンソール＋簡易収集（CSV/GA4どちらか）

---

## 6. 非機能要件
- **パフォーマンス**: モバイル4G環境で、アップロード→推薦表示までP90 ≤ 4秒（クラウドOCR時目安）。**CSV取得は初回のみ**で以降はキャッシュ利用（5〜15分）。
- **信頼性**: OCR失敗時は**必ず手入力で完了可能**
- **セキュリティ**: 画像は**一時保存**、60分で自動削除。PIIは扱わない。HTTPS必須、CSRF/XSS対策。
- **データ可用性**: Googleシート取得に失敗した場合はキャッシュを使用。キャッシュも無ければ「手入力のみ」で継続。
- **互換性**: iOS 16+/Android 11+、主要ブラウザ最新2バージョン
- **アクセシビリティ**: アルトテキスト、キーボード操作、色コントラストAA相当
- **運用**: 環境変数でOCR/リンク切替。デモ後のログ削除手順を用意。

---

## 7. 外部サービス/インフラ（例）
- フロント: Next.js or 静的SPA（React/Vite）
- API: Node/Express または Python/FastAPI（単一コンテナ）
- OCR: Google Vision / Azure Read / PaddleOCR（Docker）
- DB: SQLite（同梱ファイル）
- ストレージ: ローカル（デモ環境内）
- ホスティング: 単一VM or PaaS（Render/Fly.io 等、社内要件に合わせる）

---

## 8. API 仕様（暫定）
### POST `/api/recognize`
- 入力: `multipart/form-data`（`image`）
- 出力(JSON):
```json
{
  "size": "205/55R16",
  "li": 91,
  "ss": "V",
  "season": "summer",
  "brand": "BrandX",
  "pattern": "Comfort A",
  "confidence": {"size": 0.93, "li": 0.81, "ss": 0.77}
}
```

### POST `/api/recommend`
- 入力(JSON): `{ size, li, ss, season? }`
- 出力(JSON):
```json
{
  "items": [
    {
      "sku": "SKU123",
      "brand": "BrandX",
      "pattern": "Comfort A",
      "size": "205/55R16",
      "li": 91,
      "ss": "V",
      "price": 12000,
      "season": "summer",
      "quiet_score": 4,
      "eco_score": 5,
      "product_url": "https://example.com/sku123",
      "summary": "静粛性と低燃費性能を両立した街乗り向けモデル。"
    }
  ]
}
```

---

## 9. テスト計画（主要観点）
1. **鮮明写真**でサイズ/LI/SS/季節を正しく抽出
2. **暗所/斜め/ブレ**でもサイズ抽出≥80%成功（LI/SSは手入力で完了）
3. 読取不能時、**必ず手入力で推薦が出る**
4. **LI/SSが現タイヤ未満**のSKUは**表示されない**
5. 季節が不明の場合、**ユーザー選択で結果が変わる**
6. 価格・在庫・説明がカードに正しく表示
7. 商品リンクが設定に応じて**本番/ダミー**に切替
8. **GoogleシートCSVの取得成功/失敗**時のハンドリング（成功→一覧表示、失敗→キャッシュ/手入力のみ）およびイベントログが想定通り記録
9. 画像が60分後に自動削除
10. 主要端末/ブラウザで表示崩れがない

---

## 10. 受け入れ基準（Definition of Done）
- UC-1/2/3が**すべてデモ時に再現**できる
- 同一画像で**連続3回**の実行結果がロジック上**一貫**（候補順に許容誤差±1位）
- 安全条件（LI/SS未満の非表示）が**常に守られる**
- 説明文が**80–120字**で冗長表現を含まない
- 画像の自動削除・ログ記録が仕様どおり

---

## 11. デモシナリオ（台本）
1) トップで撮影ガイド→「写真をアップロード」
2) 鮮明写真で即抽出→サイズ/LI/SS/季節が自動入力→「次へ」
3) 推薦3件表示→1件をクリック→販売ページ（ダミー/本番）へ
4) 失敗例サンプルを試す→候補が2案→不足文字を手入力→推薦更新→クリック
5) 季節未検出例→季節フィルタを選ぶ→結果が変化

---

## 12. 制約・既知の限界
- 汚れ/摩耗/亀裂で文字欠損が大きい場合、読取は困難
- 海外表記・特殊サイズ（商用車/旧規格）は辞書拡張が必要
- ブランド/パターンはロゴ依存が高く、誤検出時は**安全ガードで回避**（サイズ/LI/SSを優先）

---

## 13. 移行・拡張（将来）
- 物体検出モデルによる自動トリミングの強化
- 車種カタログ連携（型式→規格推定→差分チェック）
- 在庫・価格のリアルタイムAPI連携
- 店舗予約/取り付けスロット表示
- 粗利/在庫/季節性を加味した**ランキング学習**

---

## 14. 法務・表記
- 本デモは**参考提案**であり、法規適合の最終責任は取り付け事業者に帰属
- 画像は一時保存・60分で削除、個人情報は収集しない旨の同意文をアップロード前に表示

---

## 15. 付録
### 15.1 正規表現例と優先順位
- `size`: `\b\d{3}\/\d{2}R?\d{2}\b`
- `li`: `\b\d{2,3}\b`（サイズ近傍の候補を優先）
- `ss`: `\b[ABCDEFGHJKLMNPQRSTUVWYZ]{1,2}\b`
- 優先順位: **サイズ→LI→SS→季節→ブランド/パターン**

### 15.2 サンプルSKU（最小）
- BrandX / Comfort A / 205/55R16 91V / 夏 / 価格: 12,000 / 在庫: あり
- BrandY / Eco B / 205/55R16 92H / オール / 価格: 11,500 / 在庫: 少
- BrandZ / Quiet C / 205/55R16 91W / 夏 / 価格: 13,800 / 在庫: あり

---

以上。

